import requests
import re
from typing import Optional, List

OLLAMA_URL = "http://localhost:11434/v1/chat/completions"
MODEL_NAME = "qwen2.5:7b"

# ===============================
# CHAT ì „ìš© í”„ë¡¬í”„íŠ¸ (ê¸°ì¡´ ìœ ì§€)
# ===============================
SYSTEM_PROMPT_CHAT = """
ë„ˆëŠ” í•œêµ­ì–´ ì‚¬ìš©ì ì „ìš© ìš”ë¦¬ ì¶”ì²œ ì±—ë´‡ì´ë‹¤.

â— ë§¤ìš° ì¤‘ìš”:
- ì¶œë ¥ì—ëŠ” **í•œê¸€ê³¼ í•œêµ­ì–´ ë¬¸ì¥ë¶€í˜¸ë§Œ** ì‚¬ìš©í•˜ë¼.
- ì¤‘êµ­ì–´, ì˜ì–´, í•œì, ì¼ë³¸ì–´, ì´ëª¨ì§€, ì™¸êµ­ì–´ ë‹¨ì–´ë¥¼
  ë‹¨ í•˜ë‚˜ë¼ë„ í¬í•¨í•˜ë©´ ì•ˆ ëœë‹¤.
- ì™¸êµ­ì–´ê°€ ë– ì˜¤ë¥´ë”ë¼ë„ ë°˜ë“œì‹œ **ìˆœìˆ˜ í•œêµ­ì–´ë¡œ ë‹¤ì‹œ ë°”ê¿”ì„œ** ì¶œë ¥í•˜ë¼.
- ì´ ê·œì¹™ì„ ì–´ê¸°ë©´ ì˜ëª»ëœ ë‹µë³€ì´ë‹¤.

ì•„ë˜ì—ëŠ”:
- ì‚¬ìš©ì ìš”ì²­
- ì§ì „ ì¶”ì²œ ë ˆì‹œí”¼ (ì—†ì„ ìˆ˜ë„ ìˆìŒ)
- ì´ë²ˆì— í™•ì •ëœ ë ˆì‹œí”¼ ì •ë³´
ê°€ ì£¼ì–´ì§„ë‹¤.

ì¤‘ìš” ê·œì¹™:
- ì´ë¯¸ í™•ì •ëœ ë ˆì‹œí”¼ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì œì•ˆí•˜ë¼.
- ë‹¤ë¥¸ ìš”ë¦¬ë¥¼ ì¶”ì²œí•˜ê±°ë‚˜ ë¹„êµí•˜ì§€ ë§ˆë¼.
- ì¬ë£Œë‚˜ ì¡°ë¦¬ë²•ì„ ìƒˆë¡œ ì¶”ì¸¡í•˜ì§€ ë§ˆë¼.
- ì‚¬ìš©ìì˜ ìš”ì²­ì„ ë‹¤ì‹œ ì„¤ëª…í•˜ì§€ ë§ˆë¼.
- "ì›í•˜ì…¨ëŠ”ë°", "ìš”ì²­ì— ë¶€í•©í•©ë‹ˆë‹¤" ê°™ì€ ë©”íƒ€ ì„¤ëª…ì„ ì“°ì§€ ë§ˆë¼.
- ì‚¬ìš©ìì˜ ì˜ë„ë¥¼ ë‹¨ì •í•˜ì§€ ë§ê³  ì œì•ˆí˜•ìœ¼ë¡œ ë§í•˜ë¼.
- ì¡°ì‚¬ì™€ ë„ì–´ì“°ê¸°ê°€ ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•˜ë¼.
- ë ˆì‹œí”¼ ì´ë¦„ì€ ë¬¸ì¥ ì†ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì–¸ê¸‰í•˜ë¼.
- ì‚¬ìš©ì ìš”ì²­ì—ì„œ ì–¸ê¸‰í•œ ì¬ë£Œë‚˜ ì¡°ê±´ì„ ë¶€ì •í•˜ê±°ë‚˜ ì•½í™”ì‹œí‚¤ëŠ” í‘œí˜„
  (ì˜ˆ: "~ì—†ì´ë„", "~ì•„ë‹ˆì–´ë„", "~ìƒê´€ì—†ì´")ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆë¼.

ì¶œë ¥ ê·œì¹™:
- ì¶”ì²œ ì´ìœ ëŠ” **ìì—°ìŠ¤ëŸ¬ìš´ í•œ ë¬¸ì¥**ìœ¼ë¡œ ì‘ì„±í•œë‹¤.
- ì„¤ëª…ë¬¸, ë³´ê³ ì„œì²´, í‰ê°€ë¬¸ì²˜ëŸ¼ ì“°ì§€ ë§ˆë¼.
- ì¹œêµ¬ì—ê²Œ ë§í•˜ë“¯ ê°„ë‹¨í•˜ê²Œ ë§í•œë‹¤.
"""

# ===============================
# FRIDGE ì „ìš© í”„ë¡¬í”„íŠ¸ (í•µì‹¬)
# ===============================
SYSTEM_PROMPT_FRIDGE = """
ë„ˆëŠ” ëƒ‰ì¥ê³  ì¬ë£Œ ê¸°ë°˜ ìš”ë¦¬ ì¶”ì²œ ë„ìš°ë¯¸ë‹¤.

â— ë§¤ìš° ì¤‘ìš”:
- ì•„ë˜ [ì‚¬ìš©ì ë³´ìœ  ì¬ë£Œ]ì— ìˆëŠ” ì¬ë£Œë§Œ ì–¸ê¸‰í•˜ë¼.
- ëª©ë¡ì— ì—†ëŠ” ì¬ë£ŒëŠ” ì ˆëŒ€ ì–¸ê¸‰í•˜ì§€ ë§ˆë¼.
- "ìˆë‚˜ìš”?", "ì¶”ê°€ë¡œ í•„ìš”í•´ìš”" ê°™ì€ ì§ˆë¬¸ì„ í•˜ì§€ ë§ˆë¼.
- ì¬ë£Œë¥¼ ì¶”ì¸¡í•˜ê±°ë‚˜ ë³´ì™„í•˜ì§€ ë§ˆë¼.
- ì´ë¯¸ í™•ì •ëœ ë ˆì‹œí”¼ë§Œ ì–¸ê¸‰í•˜ë¼.


ì¶œë ¥ ê·œì¹™:
- ì¶”ì²œ ì´ìœ ë¥¼ ìì—°ìŠ¤ëŸ¬ìš´ í•œ ë¬¸ì¥ìœ¼ë¡œë§Œ ì‘ì„±í•œë‹¤.
- ì¹œêµ¬ì—ê²Œ ë§í•˜ë“¯ ê°„ë‹¨í•˜ê²Œ ë§í•œë‹¤.
- í•œêµ­ì–´ë§Œ ì‚¬ìš©í•œë‹¤.
"""

# ===============================
# ìœ í‹¸
# ===============================
def ensure_korean_only(text: str) -> str:
    # í•œê¸€, ìˆ«ì, ê³µë°±, ê¸°ë³¸ ë¬¸ì¥ë¶€í˜¸ë§Œ ìœ ì§€
    return re.sub(r"[^ê°€-í£0-9\s.,!?~]", "", text)


# ===============================
# ì‘ë‹µ ìƒì„± í•¨ìˆ˜
# ===============================
def generate_response(
    user_query: str,
    recipe: dict,
    prev_recipe: Optional[dict] = None,
    mode: str = "chat",  # "chat" | "fridge"
    fridge_ingredients: Optional[List[str]] = None,
) -> str:

    # ğŸ”¹ ëª¨ë“œì— ë”°ë¥¸ SYSTEM PROMPT ì„ íƒ
    system_prompt = SYSTEM_PROMPT_CHAT
    if mode == "fridge":
        system_prompt = SYSTEM_PROMPT_FRIDGE

    # ğŸ”¹ ì§ì „ ë ˆì‹œí”¼ ì»¨í…ìŠ¤íŠ¸
    if prev_recipe:
        context_text = f"""
[ì§ì „ ì¶”ì²œ ë ˆì‹œí”¼]
ì´ë¦„: {prev_recipe["name"]}
"""
    else:
        context_text = "[ì§ì „ ì¶”ì²œ ë ˆì‹œí”¼]\nì—†ìŒ"

    # ğŸ”¹ ëƒ‰ì¥ê³  ëª¨ë“œì¼ ë•Œë§Œ ë³´ìœ  ì¬ë£Œ ëª…ì‹œ
    fridge_block = ""
    if mode == "fridge" and fridge_ingredients:
        fridge_block = f"""
[ì‚¬ìš©ì ë³´ìœ  ì¬ë£Œ]
{fridge_ingredients}
"""

    # ğŸ”¹ USER PROMPT
    user_prompt = f"""
[ì‚¬ìš©ì ìš”ì²­]
{user_query}

{context_text}

{fridge_block}

[ì´ë²ˆì— í™•ì •ëœ ë ˆì‹œí”¼]
ì´ë¦„: {recipe.get("name")}
ì£¼ìš” ì¬ë£Œ: {recipe.get("ingredient")}

ìœ„ ì •ë³´ë¥¼ ì°¸ê³ í•´ì„œ
ì‚¬ìš©ìì—ê²Œ ì´ ë ˆì‹œí”¼ë¥¼ ê°€ë³ê²Œ ì¶”ì²œí•˜ëŠ” í•œ ë¬¸ì¥ì„ ì¨ì¤˜.
"""

    body = {
        "model": MODEL_NAME,
        "temperature": 0.2,
        "stream": False,
        "messages": [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt},
        ],
    }

    try:
        res = requests.post(OLLAMA_URL, json=body, timeout=20)
        res.raise_for_status()
        content = res.json()["choices"][0]["message"]["content"].strip()
    except Exception:
        content = ""

    # ğŸ”¹ í•œêµ­ì–´ ê°•ì œ í•„í„°
    content = ensure_korean_only(content).strip()

    # ğŸ”¹ ìµœì¢… fallback
    if not content:
        content = f"{recipe.get('name', 'ì´ ìš”ë¦¬')} ë¨¹ê¸° ë”± ì¢‹ì€ íƒ€ì´ë°ì´ì—ìš”."

    return content